name: Gemini PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop, dev01 ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gemini-pr-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR changed files
        id: pr-changes
        run: |
          # Get the list of files changed in this PR
          gh pr diff ${{ github.event.pull_request.number }} --name-only > changed_files.txt
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR diff
        id: pr-diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          cat pr_diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Gemini PR Code Analysis
        uses: google-gemini/gemini-code-assist@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          model: gemini-1.5-pro-latest
          files: ${{ steps.pr-changes.outputs.files }}
          prompt: |
            Bu Pull Request'i detaylÄ± olarak inceleyip code review yapÄ±n:
            
            **PR Bilgileri:**
            - PR NumarasÄ±: #${{ github.event.pull_request.number }}
            - BaÅŸlÄ±k: ${{ github.event.pull_request.title }}
            - AÃ§Ä±klama: ${{ github.event.pull_request.body }}
            - Yazar: ${{ github.event.pull_request.user.login }}
            
            **DeÄŸiÅŸen Dosyalar:**
            ${{ steps.pr-changes.outputs.files }}
            
            **Diff Ä°Ã§eriÄŸi:**
            ```diff
            ${{ steps.pr-diff.outputs.diff_content }}
            ```
            
            **Ä°nceleme AlanlarÄ±:**
            1. **Kod Kalitesi & Standards**: Clean code, naming conventions, structure
            2. **Functionality**: Logic doÄŸruluÄŸu, edge case handling
            3. **Security**: Input validation, authentication, authorization
            4. **Performance**: Efficiency, scalability, resource usage
            5. **Testing**: Test coverage, test quality
            6. **Documentation**: Code comments, README updates
            7. **Breaking Changes**: Backward compatibility
            8. **PeakActivity Specifics**: ActivityWatch integration, Firebase usage, AI components
            
            **Review Format:**
            ```markdown
            ## ğŸ” Pull Request Ä°ncelemesi - PR #${{ github.event.pull_request.number }}
            
            ### ğŸ“‹ Ã–zet
            [PR'Ä±n genel amacÄ± ve kapsamÄ±]
            
            ### âœ… Pozitif YÃ¶nler
            - [Ä°yi implement edilmiÅŸ Ã¶zellikler]
            - [Kod kalitesi aÃ§Ä±sÄ±ndan gÃ¼Ã§lÃ¼ yÃ¶nler]
            
            ### âš ï¸ Ä°yileÅŸtirme Gereken Alanlar
            - **High Priority**: [Kritik sorunlar]
            - **Medium Priority**: [Orta Ã¶ncelikli iyileÅŸtirmeler]
            - **Low Priority**: [Nice-to-have iyileÅŸtirmeler]
            
            ### ğŸ”’ GÃ¼venlik Ä°ncelemesi
            - [GÃ¼venlik aÃ§Ä±sÄ±ndan dikkat edilmesi gerekenler]
            
            ### ğŸš€ Performans DeÄŸerlendirmesi
            - [Performans etkileri ve Ã¶nerileri]
            
            ### ğŸ§ª Test Ã–nerileri
            - [Eklenmesi gereken testler]
            
            ### ğŸ“– DokÃ¼mantasyon
            - [GÃ¼ncellenmesi gereken dokÃ¼mantasyon]
            
            ### ğŸ¯ Action Items
            - [ ] [Merge Ã¶ncesi yapÄ±lmasÄ± gerekenler]
            
            ### ğŸ† Genel DeÄŸerlendirme
            **Merge Recommendation**: âœ… Approve / âš ï¸ Request Changes / âŒ Reject
            
            **Confidence Score**: X/10
            ```
            
            LÃ¼tfen detaylÄ± ve yapÄ±cÄ± feedback verin. TÃ¼rkÃ§e yanÄ±t verin.

      - name: Post PR Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read Gemini analysis result
            const analysisResult = process.env.GEMINI_ANALYSIS || 'Gemini PR analizi tamamlandÄ±.';
            
            // Post review comment
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: analysisResult,
              event: 'COMMENT'
            });
            
            // Also add a regular comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ğŸ¤– Gemini AI Code Review TamamlandÄ±\n\n${analysisResult}\n\n---\n*Bu review otomatik olarak Gemini AI tarafÄ±ndan gerÃ§ekleÅŸtirilmiÅŸtir.*`
            });
